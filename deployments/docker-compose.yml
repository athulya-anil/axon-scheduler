version: '3.8'

services:
  # Semantic cache service
  cache:
    build:
      context: ../cache-service
      dockerfile: Dockerfile
    container_name: axon-cache
    ports:
      - "8000:8000"
    networks:
      - axon-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # etcd for leader election and distributed coordination
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: axon-etcd
    environment:
      - ETCD_NAME=etcd0
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=axon-etcd-cluster
    ports:
      - "2379:2379"
      - "2380:2380"
    networks:
      - axon-network
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Scheduler instances (3 replicas for HA)
  scheduler-1:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.scheduler
    container_name: axon-scheduler-1
    environment:
      - NODE_ID=scheduler-1
      - HTTP_PORT=8080
      - GRPC_PORT=9090
      - ETCD_ENDPOINTS=etcd:2379
    ports:
      - "8080:8080"
      - "9090:9090"
    networks:
      - axon-network
    depends_on:
      etcd:
        condition: service_healthy
    restart: unless-stopped

  scheduler-2:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.scheduler
    container_name: axon-scheduler-2
    environment:
      - NODE_ID=scheduler-2
      - HTTP_PORT=8080
      - GRPC_PORT=9090
      - ETCD_ENDPOINTS=etcd:2379
    ports:
      - "8081:8080"
      - "9091:9090"
    networks:
      - axon-network
    depends_on:
      etcd:
        condition: service_healthy
    restart: unless-stopped

  scheduler-3:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.scheduler
    container_name: axon-scheduler-3
    environment:
      - NODE_ID=scheduler-3
      - HTTP_PORT=8080
      - GRPC_PORT=9090
      - ETCD_ENDPOINTS=etcd:2379
    ports:
      - "8082:8080"
      - "9092:9090"
    networks:
      - axon-network
    depends_on:
      etcd:
        condition: service_healthy
    restart: unless-stopped

  # Worker instances (5 replicas)
  worker-1:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.worker
    container_name: axon-worker-1
    environment:
      - WORKER_ID=worker-1
      - WORKER_PORT=50051
      - SCHEDULER_ADDR=scheduler-1:9090
      - CACHE_ADDR=http://cache:8000
    ports:
      - "50051:50051"
    networks:
      - axon-network
    depends_on:
      cache:
        condition: service_healthy
      scheduler-1:
        condition: service_started
    restart: unless-stopped

  worker-2:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.worker
    container_name: axon-worker-2
    environment:
      - WORKER_ID=worker-2
      - WORKER_PORT=50051
      - SCHEDULER_ADDR=scheduler-1:9090
      - CACHE_ADDR=http://cache:8000
    ports:
      - "50052:50051"
    networks:
      - axon-network
    depends_on:
      - cache
      - scheduler-1
    restart: unless-stopped

  worker-3:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.worker
    container_name: axon-worker-3
    environment:
      - WORKER_ID=worker-3
      - WORKER_PORT=50051
      - SCHEDULER_ADDR=scheduler-1:9090
      - CACHE_ADDR=http://cache:8000
    ports:
      - "50053:50051"
    networks:
      - axon-network
    depends_on:
      - cache
      - scheduler-1
    restart: unless-stopped

  worker-4:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.worker
    container_name: axon-worker-4
    environment:
      - WORKER_ID=worker-4
      - WORKER_PORT=50051
      - SCHEDULER_ADDR=scheduler-1:9090
      - CACHE_ADDR=http://cache:8000
    ports:
      - "50054:50051"
    networks:
      - axon-network
    depends_on:
      - cache
      - scheduler-1
    restart: unless-stopped

  worker-5:
    build:
      context: ..
      dockerfile: deployments/Dockerfile.worker
    container_name: axon-worker-5
    environment:
      - WORKER_ID=worker-5
      - WORKER_PORT=50051
      - SCHEDULER_ADDR=scheduler-1:9090
      - CACHE_ADDR=http://cache:8000
    ports:
      - "50055:50051"
    networks:
      - axon-network
    depends_on:
      - cache
      - scheduler-1
    restart: unless-stopped

networks:
  axon-network:
    driver: bridge

volumes:
  etcd-data:
